{% extends '@GerFrontend/layout.html.twig' %}

{%- block title -%}
    {{ parent() }}
    Applications
{%- endblock -%}

{% block maincontent %}
    <div class="container">
        <div class="padded row col-lg-12 col-md-12">
            <div id="breadcrumbs">
                {{ knp_menu_render('main', { 'depth': 5, 'currentClass': 'active', 'template': 'GerFrontendBundle:Menu:breadcrumb.html.twig'}) }}
            </div>
        </div>
    </div>
    <div class="row padded">
        <div class="col-lg-9 col-md-12">
            <div class="box">
                <div class="box-header">

                    <span class="title">Liste des Applications</span>
                </div>
                <div class="box-content">
                    {% if applications|length > 0 %}
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Dépend de</th>
                                <th>Requis par</th>
                                <th>Bases de données</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            {% for application in applications %}
                                <tbody>
                                <tr>
                                    <td>{{ application.name }}</td>
                                    <td>
                                        {% for dapplication in application.getDependsOnApplications %}
                                            <span class="label label-dark-red">{{ dapplication.name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% for rapplication in application.getIsRequiredByApplications %}
                                            <span class="label label-green">{{ rapplication.name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% for database in application.getRequireDatabases %}
                                            <a href="#" rel="tooltip" data-placement="bottom" title data-original-title="{{ database.type.name }}: {{ database.description }}"><span class="label label-green"><i class="icon icon-tasks" ></i> {{ database.name }}</span></a>
                                        {% endfor %}
                                    </td>
                                    <td>

                                        <a class="btn btn-gold"
                                           href="{{ path("api_applications_get_edit_application",{ 'id': application.id }) }}">Editer
                                            <i class="icon icon-arrow-right"></i></a>
                                        <a class="btn btn-red"
                                           href="{{ path("api_applications_get_delete_application",{ 'id': application.id }) }}">Supprimer</a>
                                    </td>
                                </tr>
                                </tbody>
                            {% endfor %}
                        </table>
                    {% else %}
                        <div class="">
                            <div class="col-lg-4 col-lg-offset-4">Aucune Application défini</div>
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>
        <div class="col-lg-3 col-md-4">

            <div class="box">
                <div class="box-header">
                    <span class="title">
                        {% if type == 'creation' %}
                            Ajouter une Application
                        {% else %}
                            Modifier l'Application
                        {% endif %}
                    </span>
                </div>

                <div class="box-content">
                    {{ form_start(form,{ 'action': action, attr: { 'novalidate': 'novalidate', 'method': 'POST' } }) }}
                    <div class="row">
                        <div class="col-lg-12">

                            <ul class="padded separate-sections">

                                <li class="input">
                                    {{ form_widget(form.name, { 'attr': { 'placeholder': 'Nom', 'style': 'cursor: auto;  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABHklEQVQ4EaVTO26DQBD1ohQWaS2lg9JybZ+AK7hNwx2oIoVf4UPQ0Lj1FdKktevIpel8AKNUkDcWMxpgSaIEaTVv3sx7uztiTdu2s/98DywOw3Dued4Who/M2aIx5lZV1aEsy0+qiwHELyi+Ytl0PQ69SxAxkWIA4RMRTdNsKE59juMcuZd6xIAFeZ6fGCdJ8kY4y7KAuTRNGd7jyEBXsdOPE3a0QGPsniOnnYMO67LgSQN9T41F2QGrQRRFCwyzoIF2qyBuKKbcOgPXdVeY9rMWgNsjf9ccYesJhk3f5dYT1HX9gR0LLQR30TnjkUEcx2uIuS4RnI+aj6sJR0AM8AaumPaM/rRehyWhXqbFAA9kh3/8/NvHxAYGAsZ/il8IalkCLBfNVAAAAABJRU5ErkJggg==); background-attachment: scroll; background-position: 100% 50%; background-repeat: no-repeat;' }}
                                    ) }}
                                    {% if form_errors(form.name)|length > 0 %}
                                </li>
                                <li class="clearfix" style="margin-left: 30px;">
                                    <div class="note pull-left alert-danger">{{ form_errors(form.name) }}</div>
                                </li>
                                {% endif %}
                                <li>
                                    {{ form_widget(form.depends_on_applications) }}
                                    {% if form_errors(form.depends_on_applications)|length > 0 %}
                                </li>
                                <li class="clearfix" style="margin-left: 30px;">
                                    <div class="note pull-left alert-danger">{{ form_errors(form.depends_on_applications) }}</div>
                                </li>
                                {% endif %}
                                <li>
                                    <ul class="require_databases" data-prototype="{{ form_widget(form.require_databases.vars.prototype)|e }}">
                                        {% for application_database in form.require_databases %}
                                            <li>{{ form_widget(application_database) }}</li>
                                        {% endfor %}
                                    </ul>
                                </li>

                            </ul>
                        </div>

                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-blue">Soumettre</button>
                    </div>

                </div>
            </div>

            {{ form_rest(form) }}

        </div>
    </div>
    </div>


{% endblock %}

{% block javascripts  %}
    {{ parent() }}
    <script>
        var collectionHolder = $('ul.require_databases');

        // ajoute un lien « add a tag »
        var $addDatabaseLink = $('<a href="#" class="add_database_link btn btn-blue">Ajouter une Base de donnée</a>');
        var $newLinkLi = $('<li></li>').append($addDatabaseLink);

        jQuery(document).ready(function() {
            // ajoute l'ancre « ajouter un tag » et li à la balise ul
            collectionHolder.append($newLinkLi);

            $addDatabaseLink.on('click', function(e) {
                // empêche le lien de créer un « # » dans l'URL
                e.preventDefault();

                // ajoute un nouveau formulaire tag (voir le prochain bloc de code)
                addDatabaseForm(collectionHolder, $newLinkLi);
            });
        });

        function addDatabaseForm(collectionHolder, $newLinkLi) {
            // Récupère l'élément ayant l'attribut data-prototype comme expliqué plus tôt
            var prototype = collectionHolder.attr('data-prototype');

            // Remplace '__name__' dans le HTML du prototype par un nombre basé sur
            // la longueur de la collection courante
            var newForm = prototype.replace(/__name__/g, collectionHolder.children().length);

            // Affiche le formulaire dans la page dans un li, avant le lien "ajouter un tag"
            var $newFormLi = $('<li></li>').append(newForm);
            $newLinkLi.before($newFormLi);
        }
    </script>
{% endblock %}